<!doctype html>
<html class="no-js" lang="">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>TEAM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/main.css">
  <style>
    body {background: #000; font-family: Arial; font-size: 200%; color: #fff; margin: 0; padding: 0;}
    #wrapper {text-align: center; width: 600px; height: 300px; color: #fff; position: absolute; top:0; bottom: 0; left: 0; right: 0; margin: auto; }
    .icon {vertical-align: baseline; opacity: 0.6;}
    .column-30 {width: 32%; float: left;}
    .column-15 {width: 16%; float: left;}
    .myself.body small {display: block; padding-top: 5px; font-size: 8pt;}
    .team.body small {display: block; padding-top: 5px; font-size: 6pt;}
    .myself.readings p {width: 100%; height: 70px; line-height: 70px; }
    .myself.readings p.chart {height: 40px;}
    .myself.readings .fa {line-height: 70px; opacity: 0.6;}
    .myself.readings big {display: inline-block; height: 54px; font-size: 40pt; width: 130px; overflow: hidden; font-weight: bold;}
    .myself.readings small {display: inline; font-size: 8pt; font-weight: normal; opacity: 0.6;}
    .team.readings p {width: 100%; height: 40px; line-height: 34px; }
    .team.readings big {display: inline-block; height: 26px; font-size: 18pt; width: 67px; overflow: hidden; font-weight: bold;}
    .team.readings small {display: inline; font-size: 5pt; font-weight: normal; opacity: 0.6;}
    #team-1 {font-size: 200pt;  }
    #team-2 {font-size: 55pt;  }
    #team-3 {font-size: 55pt;  }
    #team-4 {font-size: 55pt;  }
    #radDOM2, #pressureDOM2, #radDOM3, #pressureDOM3, #radDOM4, #pressureDOM4 {color: #00FF00;}
  </style>
  <script type="text/javascript">
  // Add cordova js
  if (navigator.userAgent.match(/android|iphone|ipad/i)) {
      document.write("<script src='cordova.js'><\/script>");
  } else {
    setTimeout(function() {
      window.mockReadings();
    }, 500);
  }
  </script>
  <script src="js/vendor/modernizr-2.8.3.min.js"></script>
</head>
<body style="text-align:center;">

  <div id="wrapper">
    <div class="column-30 myself body">
      <i id="team-1" class="fa fa-male fa-5x" aria-hidden="true"></i>
      <small>GOKU</small>
    </div>
    <div class="column-30 myself readings">
      <p><img src="img/radiation.svg" width="25" class="icon"/><big id="radDOM1">-</big><small>μS/h</small></p>
      <p class="chart" id="radChart">&nbsp;</p>
      <p><img src="img/pressure.svg" width="25" class="icon"/><big id="pressureDOM1">927</big><small>Pa</small></p>
      <p class="chart" id="presureChart">&nbsp;</p>
      <p id="serialConsole" style="text-align:left;line-height:8px;padding:2px;border:1px solid #333;height:30px;font-size:8px;overflow-y:scroll;" onclick="alert(this.innerText)">serial data..</p>
    </div>
    <div class="column-15 team body">
      <p><i id="team-2" class="fa fa-male fa-2x" aria-hidden="true"></i><small>VEGETA</small></p>
      <p><i id="team-3" class="fa fa-male fa-2x" aria-hidden="true"></i><small>GOHAN</small></p>
      <p><i id="team-4" class="fa fa-male fa-2x" aria-hidden="true"></i><small>PICCOLO</small></p>
    </div>
    <div class="column-15 team readings">
      <p><img src="img/radiation.svg" width="12" class="icon"/><big id="radDOM2">23</big><small>μS/h</small></p>
      <p><img src="img/pressure.svg" width="12" class="icon"/><big id="pressureDOM2">1056</big><small>Pa</small></p>
      <p><img src="img/radiation.svg" width="12" class="icon"/><big id="radDOM3">42</big><small>μS/h</small></p>
      <p><img src="img/pressure.svg" width="12" class="icon"/><big id="pressureDOM3">934</big><small>Pa</small></p>
      <p><img src="img/radiation.svg" width="12" class="icon"/><big id="radDOM4">35</big><small>μS/h</small></p>
      <p><img src="img/pressure.svg" width="12" class="icon"/><big id="pressureDOM4">989</big><small>Pa</small></p>
    </div>
  </div>

  <script src="js/vendor/jquery-1.11.2.min.js"></script>
  <script src="js/vendor/jquery.sparkline.min.js"></script>
  <script src="js/main.js"></script>
  <script>
// Initialise vars _____________________________________________

var radDOM1 = document.getElementById('radDOM1');
var radDOM2 = document.getElementById('radDOM2');
var radDOM3 = document.getElementById('radDOM3');
var radDOM4 = document.getElementById('radDOM4');
var pressureDOM1 = document.getElementById('pressureDOM1');
var pressureDOM2 = document.getElementById('pressureDOM2');
var pressureDOM3 = document.getElementById('pressureDOM3');
var pressureDOM4 = document.getElementById('pressureDOM4');
var lastRadiationReading = 40;
var lastPressureReading = 1000;
var lastChartUpdate = 0;
var radiationHistory = [];
var pressureHistory = [];
var intervalID = 0;

// Helper functions __________________________________________

function getRadiationColor(val) {
    val = val / 3;
    var r = 0, g = 0, b = 0;
    if (val < -50) b = 100;
    else if (val < 0) b = Math.abs(val) * 2;
    if (val > 50) r = 100;
    else if (val > 0) r = Math.abs(val) * 2;
    if (val > -50 && val < 50) g = 100;
    else g = (100 - Math.abs(val)) * 2  ;
    return 'rgb(' + r + '%, ' + g +'%, ' + b + '%)';
}

function getPressureColor(val) {
    var r = 0, g = 100, b = 0;
    if (val < 500) r = 100;
    else if (val < 1000) r = (1000 - val) / 5;
    if (val > 2000) r = 100;
    else if (val > 1000) r = Math.abs(1000 - val) / 10;
    if (val < 500 || val > 2000) g = 0;
    else if (val < 1000) g = (val - 500) / 5;
    else if (val > 1000) g = (2000 - val) / 10;
    return 'rgb(' + r + '%, ' + g +'%, ' + b + '%)';
}

// Core code __________________________________________________


function displayReadings() {

    // RUN CALCULATIONS
    var radiation = Math.round(lastRadiationReading);
    var pressure = Math.round(lastPressureReading);
    radiationHistory.push(radiation);
    pressureHistory.push(pressure);
    // get latest 160 readings (for chart)
    radiationHistory = radiationHistory.splice(-160); 
    pressureHistory = pressureHistory.splice(-160);

    // DISPLAY NUMBERS
    radDOM1.innerText = radiation;
    radDOM1.style.color = getRadiationColor(radiation);
    pressureDOM1.innerText = pressure;
    pressureDOM1.style.color = getPressureColor(pressure);
    radDOM2.innerText = radiation + Math.floor(Math.random() * 3) - 6;
    radDOM2.style.color = getRadiationColor(radiation);
    pressureDOM2.innerText = pressure + Math.floor(Math.random() * 5) - 10;
    pressureDOM2.style.color = getPressureColor(pressure);
    radDOM3.innerText = radiation + Math.floor(Math.random() * 3) - 6;;
    radDOM3.style.color = getRadiationColor(radiation);
    pressureDOM3.innerText = pressure + Math.floor(Math.random() * 5) - 10;
    pressureDOM3.style.color = getPressureColor(pressure);
    radDOM4.innerText = radiation + Math.floor(Math.random() * 3) - 6;;
    radDOM4.style.color = getRadiationColor(radiation);
    pressureDOM4.innerText = pressure + Math.floor(Math.random() * 5) - 10;
    pressureDOM4.style.color = getPressureColor(pressure);

    // UPDATE CHARTS
    var chartSettings = {
      type: 'line',
      width: '180',
      height: '40',
      lineColor: '#999',
      fillColor: '#222',
      lineWidth: 1,
      spotColor: '#999',
      minSpotColor: '#999',
      maxSpotColor: '#999',
      chartRangeMin: 0};

    // UPDATE CHART EVERY HALF SEC
    var secs = Math.floor((new Date()).getTime() / 500);
    if (secs > lastChartUpdate) {
        $("#radChart").sparkline(radiationHistory, chartSettings);
        $("#presureChart").sparkline(pressureHistory, chartSettings);
        lastChartUpdate = secs;
    }

    // TOO HIGH? WARN USER WITH VIBRATION
    if (radiation > 500) {
        if (navigator.vibrate) {
          navigator.vibrate(500);
        }
        if (window.cordova && cordova.plugins && cordova.plugins.tonegenerator) {
            cordova.plugins.tonegenerator.play(900, 240);
        }
    } else {
        if (window.cordova && cordova.plugins && cordova.plugins.tonegenerator) {
            cordova.plugins.tonegenerator.stop();
        }
    }
}

function watchReadings() {
    console.log('watchReadings()'); 
    onError = function error (err) { console.log(err); };
    if (window.cordova && cordova.plugins && cordova.plugins.magnetometer) {
        cordova.plugins.magnetometer.watchReadings(
            function success (reading) {
                // COLLECT 'RADIATION' READINGS
                lastRadiationReading = reading.magnitude;
                lastPressureReading = lastPressureReading + (Math.random() * 10) - 5;
            }, onError
        );
        // Refresh display every 0.1 secs.
        intervalID = window.setInterval(displayReadings, 200);
    } else {
        console.log('No magnetometer plugin!!');
        console.log('cordova = ' + !!window.cordova);
        console.log('cordova.plugins = ' + !!cordova.plugins);
        console.log('cordova.plugins.magnetometer = ' + !!cordova.plugins.magnetometer);
    }
    if (serial && serial.requestPermission) {
      serial.requestPermission(
          function(successMessage) {
                // open serial port
                serial.open(
                    {baudRate: 9600},
                    // if port is succesfuly opened
                    function(successMessage) {
                        serial.registerReadCallback(
                          function success(data){
                              var view = new Uint8Array(data);
                              var json = JSON.stringify(view);
                              var text = $("#serialConsole").text() + "\n" + view.join();
                              console.log('serialReadCallback', view);
                              $("#serialConsole").text(text);
                          },
                          function error(){
                              console.log("Failed to register read callback");
                              $("#serialConsole").text("Failed to register read callback");
                        }
                    );
                })
          },
          onError
      );
    } else {
        console.log('No serial usb plugin!!');
    }
}

function mockReadings() {
    // No sensor available? We are on PC DEV mode, 
    // just mock sensor data.
    intervalID = window.setInterval(function() {
        lastRadiationReading = lastRadiationReading + (Math.random() * 2) - 1;
        lastPressureReading = lastPressureReading + (Math.random() * 10) - 5;
        displayReadings();
    }, 200);
}

function stop() {
    console.log('stop()'); 
    window.clearInterval(intervalID);
    if (window.cordova && cordova.plugins && cordova.plugins.magnetometer)
        cordova.plugins.magnetometer.stop();
    if (window.cordova && cordova.plugins && cordova.plugins.tonegenerator) 
        cordova.plugins.tonegenerator.stop();
}


// Device Event Listeners ___________________________________
document.addEventListener("pause", stop, false);
document.addEventListener("resume", watchReadings, false);
document.addEventListener("deviceready", watchReadings, false)


  </script>
</body>
</html>
